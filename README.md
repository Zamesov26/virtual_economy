# Виртуальная экономика

Это веб-приложение для управления виртуальной экономикой, позволяющее пользователям покупать, использовать и управлять виртуальными товарами и средствами. Приложение разработано с использованием FastAPI и асинхронных технологий.

## Особенности

- **Асинхронный API**: Построен на FastAPI с поддержкой асинхронных операций
- **Управление инвентарем**: Пользователи могут покупать и использовать виртуальные товары
- **Два типа товаров**: Расходуемые (consumable) и постоянные (permanent) товары
- **Аналитика**: Популярные товары и аналитика покупок
- **Кэширование**: Redis для кэширования данных инвентаря
- **Фоновые задачи**: Обработка задач с помощью Celery
- **Идемпотентность**: Защита от дублирования операций пополнения средств

## Технологии

- **FastAPI**: Современный веб-фреймворк для создания API
- **SQLAlchemy**: ORM для работы с PostgreSQL
- **Redis**: Для кэширования и брокера задач Celery
- **Celery**: Для обработки фоновых задач
- **Docker & Docker Compose**: Для контейнеризации
- **Pydantic**: Для валидации данных

## Структура проекта

```
├── app/                    # Основной код приложения
│   ├── api/              # Обработчики API
│   ├── database/         # Модели и настройки базы данных
│   ├── redis/            # Настройки Redis
│   ├── repositories/     # Слой доступа к данным
│   ├── services/         # Бизнес-логика
│   └── schemas/          # Pydantic схемы
├── tests/                # Тесты
├── requirements.txt      # Зависимости Python
├── docker-compose.yml    # Конфигурация Docker Compose
└── Dockerfile           # Dockerfile приложения
```

## Установка и запуск

### Требования

- Docker
- Docker Compose

### Запуск приложения

1. Скопируйте `.example.env` в `.env` и настройте переменные окружения:
   ```bash
   cp .example.env .env
   ```

2. Убедитесь, что скрипту `entrypoint.sh` предоставлены права на выполнение:
   ```bash
   chmod +x entrypoint.sh
   ```

3. Запустите приложение с помощью Docker Compose:
   ```bash
   docker-compose up --build
   ```

Приложение будет доступно по адресу `http://localhost:8000`.

### Скрипт запуска (entrypoint.sh)

Файл `entrypoint.sh` используется как точка входа в Docker-контейнер и выполняет следующие действия:
- Ожидает готовности PostgreSQL
- Запускает миграции базы данных с помощью Alembic
- Запускает приложение FastAPI с помощью uvicorn

### Запуск тестов

```bash
docker-compose exec web python -m pytest
```

## API Endpoints

- `GET /api/v1/health` - Проверка состояния сервиса
- `POST /api/v1/products/{product_id}/purchase` - Покупка товара
- `POST /api/v1/products/{product_id}/use` - Использование расходуемого товара
- `GET /api/v1/users/{user_id}/inventory` - Получение инвентаря пользователя
- `POST /api/v1/users/{user_id}/add-funds` - Пополнение средств пользователя
- `GET /api/v1/analytics/popular-products` - Получение популярных товаров

## База данных

Приложение использует PostgreSQL с следующими основными моделями:

- **User**: Пользователи с балансом средств
- **Product**: Виртуальные товары (расходуемые и постоянные)
- **Transaction**: История транзакций
- **Inventory**: Инвентарь товаров пользователя

## Кэширование

Для повышения производительности данные инвентаря кэшируются в Redis. Ключ кэша формируется как `user:{user_id}:inventory`.

## Бэкенд задач

Для обработки фоновых задач используется Celery с Redis в качестве брокера и бэкенда результатов.

## Безопасность

- Используется идемпотентность для защиты от дублирования платежей
- Проверка баланса перед покупкой
- Проверка наличия товаров перед использованием

## Тестирование

Приложение полностью покрыто тестами, включая:

- Тесты API-эндпоинтов
- Модульные тесты бизнес-логики
- Интеграционные тесты

## Лицензия

MIT